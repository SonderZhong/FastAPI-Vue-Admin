name: Release Frontend

on:
  push:
    paths:
      - 'web/**'
    branches:
      - main
      - master

jobs:
  release-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get version info
        id: version
        working-directory: web
        run: |
          FULL_VERSION=$(node -p "require('./package.json').version")
          STABLE_VERSION=$(echo $FULL_VERSION | sed 's/\.[^.]*$//')
          echo "full=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "stable=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "Full version: $FULL_VERSION, Stable version: $STABLE_VERSION"

      - name: Install dependencies
        working-directory: web
        run: pnpm install

      - name: Preload with dev server
        working-directory: web
        run: |
          timeout 30s pnpm dev || true

      - name: Build
        working-directory: web
        run: pnpm build

      - name: Create dist archive
        run: |
          cd web/dist
          zip -r ../../dist-${{ steps.version.outputs.full }}.zip .

      - name: Check if stable release exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="v${{ steps.version.outputs.stable }}"
          if gh release view "$RELEASE_TAG" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            # 获取现有的 server 包版本
            SERVER_ASSET=$(gh release view "$RELEASE_TAG" --json assets -q '.assets[].name' | grep '^server-' | head -1 || echo "")
            echo "server_asset=$SERVER_ASSET" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "server_asset=" >> $GITHUB_OUTPUT
          fi
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Delete old frontend asset if exists
        if: steps.check_release.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view ${{ steps.check_release.outputs.tag }} --json assets -q '.assets[].name' | grep '^dist-' | while read asset; do
            echo "Deleting old asset: $asset"
            gh release delete-asset ${{ steps.check_release.outputs.tag }} "$asset" -y || true
          done

      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          RELEASE_TAG="${{ steps.check_release.outputs.tag }}"
          DIST_FILE="dist-${{ steps.version.outputs.full }}.zip"
          SERVER_FILE="${{ steps.check_release.outputs.server_asset }}"
          
          # 构建下载链接
          DIST_LINK="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}/${DIST_FILE}"
          if [ -n "$SERVER_FILE" ]; then
            SERVER_LINK="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}/${SERVER_FILE}"
            SERVER_ROW="| 后端 | [${SERVER_FILE}](${SERVER_LINK}) | FastAPI + Tortoise-ORM 服务端 |"
          else
            SERVER_ROW="| 后端 | 暂无 | 等待后端发布 |"
          fi

          DIST_ROW="| 前端 | [${DIST_FILE}](${DIST_LINK}) | Vue 3 + Element Plus 构建产物 |"
          
          RELEASE_BODY=$(cat .github/RELEASE_TEMPLATE.md)
          RELEASE_BODY="${RELEASE_BODY//\{\{RELEASE_TAG\}\}/$RELEASE_TAG}"
          RELEASE_BODY="${RELEASE_BODY//\{\{DIST_ROW\}\}/$DIST_ROW}"
          RELEASE_BODY="${RELEASE_BODY//\{\{SERVER_ROW\}\}/$SERVER_ROW}"

          if [ "${{ steps.check_release.outputs.exists }}" == "true" ]; then
            gh release upload "$RELEASE_TAG" "$DIST_FILE" --clobber
            gh release edit "$RELEASE_TAG" --notes "$RELEASE_BODY"
            echo "Updated release $RELEASE_TAG"
          else
            gh release create "$RELEASE_TAG" \
              --title "Release $RELEASE_TAG" \
              --notes "$RELEASE_BODY" \
              "$DIST_FILE"
            echo "Created new release $RELEASE_TAG"
          fi

