name: Check ip2region Update

on:
  schedule:
    # 每6小时检查一次
    - cron: '0 */6 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  check-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest commit hash of ip2region.xdb
        id: check
        run: |
          # 获取目标文件最新的 commit hash
          LATEST_HASH=$(curl -s "https://api.github.com/repos/lionsoul2014/ip2region/commits?path=data/ip2region.xdb&per_page=1" | jq -r '.[0].sha')
          echo "latest_hash=$LATEST_HASH" >> $GITHUB_OUTPUT
          
          # 读取上次记录的 hash
          if [ -f .github/ip2region_hash.txt ]; then
            STORED_HASH=$(cat .github/ip2region_hash.txt)
          else
            STORED_HASH=""
          fi
          echo "stored_hash=$STORED_HASH" >> $GITHUB_OUTPUT
          
          # 判断是否有更新
          if [ "$LATEST_HASH" != "$STORED_HASH" ] && [ -n "$LATEST_HASH" ] && [ "$LATEST_HASH" != "null" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Download new ip2region.xdb
        if: steps.check.outputs.changed == 'true'
        run: |
          curl -L -o server/assets/ip2region.xdb "https://raw.githubusercontent.com/lionsoul2014/ip2region/master/data/ip2region.xdb"
          echo "${{ steps.check.outputs.latest_hash }}" > .github/ip2region_hash.txt

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add server/assets/ip2region.xdb .github/ip2region_hash.txt
          git commit -m "chore: update ip2region.xdb"
          git push
