name: Release Server

on:
  push:
    paths:
      - 'server/**'
    branches:
      - main
      - master

jobs:
  release-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          FULL_VERSION=$(grep -oP 'version:\s*"\K[^"]+' server/config.yaml | head -1)
          STABLE_VERSION=$(echo $FULL_VERSION | sed 's/\.[^.]*$//')
          echo "full=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "stable=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "Full version: $FULL_VERSION, Stable version: $STABLE_VERSION"

      - name: Create server archive
        run: |
          cd server
          zip -r ../server-${{ steps.version.outputs.full }}.zip . \
              -x "venv/*" \
              -x "__pycache__/*" \
              -x "*.pyc" \
              -x ".pytest_cache/*" \
              -x "logs/*" \
              -x "uploads/*"

      - name: Check if stable release exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="v${{ steps.version.outputs.stable }}"
          if gh release view "$RELEASE_TAG" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            # è·å–ç°æœ‰çš„ dist åŒ…ç‰ˆæœ¬
            DIST_ASSET=$(gh release view "$RELEASE_TAG" --json assets -q '.assets[].name' | grep '^dist-' | head -1 || echo "")
            echo "dist_asset=$DIST_ASSET" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "dist_asset=" >> $GITHUB_OUTPUT
          fi
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Delete old server asset if exists
        if: steps.check_release.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view ${{ steps.check_release.outputs.tag }} --json assets -q '.assets[].name' | grep '^server-' | while read asset; do
            echo "Deleting old asset: $asset"
            gh release delete-asset ${{ steps.check_release.outputs.tag }} "$asset" -y || true
          done

      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          RELEASE_TAG="${{ steps.check_release.outputs.tag }}"
          SERVER_FILE="server-${{ steps.version.outputs.full }}.zip"
          DIST_FILE="${{ steps.check_release.outputs.dist_asset }}"
          
          # æ„å»ºä¸‹è½½é“¾æ¥
          SERVER_LINK="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}/${SERVER_FILE}"
          if [ -n "$DIST_FILE" ]; then
            DIST_LINK="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}/${DIST_FILE}"
            DIST_ROW="| å‰ç«¯ | [${DIST_FILE}](${DIST_LINK}) | Vue 3 + Element Plus æ„å»ºäº§ç‰© |"
          else
            DIST_ROW="| å‰ç«¯ | æš‚æ—  | ç­‰å¾…å‰ç«¯å‘å¸ƒ |"
          fi

          RELEASE_BODY="## Release $RELEASE_TAG

ğŸ¯ **åœ¨çº¿æ¼”ç¤º**: [https://fva.hygc.site](https://fva.hygc.site) - è´¦å·: \`admin\` å¯†ç : \`admin123@*\`

ğŸ“š **æ–‡æ¡£åœ°å€**: [https://sonderzhong.github.io/FastAPI-Vue-Admin/](https://sonderzhong.github.io/FastAPI-Vue-Admin/)

### ğŸ“¦ ä¸‹è½½åœ°å€
| ç±»å‹ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
${DIST_ROW}
| åç«¯ | [${SERVER_FILE}](${SERVER_LINK}) | FastAPI + Tortoise-ORM æœåŠ¡ç«¯ |

---

### ğŸ–¥ï¸ åç«¯éƒ¨ç½²

\`\`\`bash
# 1. è§£å‹æ–‡ä»¶
unzip server-x.x.x.zip -d /path/to/server

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
cd /path/to/server
python -m venv venv

# 3. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Windows
venv\\Scripts\\activate
# Linux/Mac
source venv/bin/activate

# 4. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 5. é…ç½® config.yamlï¼ˆæ•°æ®åº“ã€Redisç­‰ï¼‰

# 6. å¯åŠ¨æœåŠ¡
python main.py
\`\`\`

é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨è¿›å…¥åˆå§‹åŒ–å‘å¯¼é¡µé¢ http://localhost:9090

---

### ğŸŒ Nginx ä»£ç†é…ç½®

\`\`\`nginx
server {
    listen 80;
    server_name your-domain.com;
    
    root /path/to/dist;
    index index.html;
    
    # å‰ç«¯è·¯ç”±
    location / {
        try_files \\\$uri \\\$uri/ /index.html;
    }
    
    # API ä»£ç†
    location /api {
        rewrite ^.+api/?(.*)\\\$ /\\\$1 break;
        proxy_pass http://127.0.0.1:9090/;
        proxy_set_header Host \\\$host;
        proxy_set_header X-Real-IP \\\$remote_addr;
        proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;
        proxy_set_header REMOTE-HOST \\\$remote_addr;
        proxy_set_header Upgrade \\\$http_upgrade;
        proxy_set_header Connection \\\$http_connection;
        proxy_set_header X-Forwarded-Proto \\\$scheme;
        proxy_http_version 1.1;
    }
    
    # æ–‡ä»¶ä»£ç†
    location /files {
        proxy_pass http://127.0.0.1:9090;
        proxy_set_header Host \\\$host;
        proxy_set_header X-Real-IP \\\$remote_addr;
        proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
    }
}
\`\`\`"

          if [ "${{ steps.check_release.outputs.exists }}" == "true" ]; then
            gh release upload "$RELEASE_TAG" "$SERVER_FILE" --clobber
            gh release edit "$RELEASE_TAG" --notes "$RELEASE_BODY"
            echo "Updated release $RELEASE_TAG"
          else
            gh release create "$RELEASE_TAG" \
              --title "Release $RELEASE_TAG" \
              --notes "$RELEASE_BODY" \
              "$SERVER_FILE"
            echo "Created new release $RELEASE_TAG"
          fi
