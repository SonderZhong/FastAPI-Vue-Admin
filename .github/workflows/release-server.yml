name: Release Server

on:
  push:
    paths:
      - 'server/**'
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  release-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          FULL_VERSION=$(grep -oP 'version:\s*"\K[^"]+' server/config.yaml | head -1)
          STABLE_VERSION=$(echo $FULL_VERSION | sed 's/\.[^.]*$//')
          echo "full=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "stable=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "Full version: $FULL_VERSION, Stable version: $STABLE_VERSION"

      - name: Create server archive
        run: |
          cd server
          zip -r ../server-${{ steps.version.outputs.full }}.zip . \
              -x "venv/*" \
              -x "__pycache__/*" \
              -x "*.pyc" \
              -x ".pytest_cache/*" \
              -x "logs/*" \
              -x "uploads/*"

      - name: Check if stable release exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="v${{ steps.version.outputs.stable }}"
          if gh release view "$RELEASE_TAG" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            # 获取现有的 dist 包版本
            DIST_ASSET=$(gh release view "$RELEASE_TAG" --json assets -q '.assets[].name' | grep '^dist-' | head -1 || echo "")
            echo "dist_asset=$DIST_ASSET" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "dist_asset=" >> $GITHUB_OUTPUT
          fi
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Delete old server asset if exists
        if: steps.check_release.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view ${{ steps.check_release.outputs.tag }} --json assets -q '.assets[].name' | grep '^server-' | while read asset; do
            echo "Deleting old asset: $asset"
            gh release delete-asset ${{ steps.check_release.outputs.tag }} "$asset" -y || true
          done

      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          RELEASE_TAG="${{ steps.check_release.outputs.tag }}"
          SERVER_FILE="server-${{ steps.version.outputs.full }}.zip"
          DIST_FILE="${{ steps.check_release.outputs.dist_asset }}"
          
          # 构建下载链接
          SERVER_LINK="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}/${SERVER_FILE}"
          if [ -n "$DIST_FILE" ]; then
            DIST_LINK="https://github.com/${GITHUB_REPOSITORY}/releases/download/${RELEASE_TAG}/${DIST_FILE}"
            DIST_ROW="| 前端 | [${DIST_FILE}](${DIST_LINK}) | Vue 3 + Element Plus 构建产物 |"
          else
            DIST_ROW="| 前端 | 暂无 | 等待前端发布 |"
          fi

          SERVER_ROW="| 后端 | [${SERVER_FILE}](${SERVER_LINK}) | FastAPI + Tortoise-ORM 服务端 |"
          
          RELEASE_BODY=$(cat .github/RELEASE_TEMPLATE.md)
          RELEASE_BODY="${RELEASE_BODY//\{\{RELEASE_TAG\}\}/$RELEASE_TAG}"
          RELEASE_BODY="${RELEASE_BODY//\{\{DIST_ROW\}\}/$DIST_ROW}"
          RELEASE_BODY="${RELEASE_BODY//\{\{SERVER_ROW\}\}/$SERVER_ROW}"

          if [ "${{ steps.check_release.outputs.exists }}" == "true" ]; then
            gh release upload "$RELEASE_TAG" "$SERVER_FILE" --clobber
            gh release edit "$RELEASE_TAG" --notes "$RELEASE_BODY"
            echo "Updated release $RELEASE_TAG"
          else
            gh release create "$RELEASE_TAG" \
              --title "Release $RELEASE_TAG" \
              --notes "$RELEASE_BODY" \
              "$SERVER_FILE"
            echo "Created new release $RELEASE_TAG"
          fi

